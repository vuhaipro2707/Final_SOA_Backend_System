# Cấu hình worker processes
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Bao gồm MIME types
    include       mime.types;
    default_type  application/octet-stream;
    
    # Cấu hình để Nginx không đợi quá lâu cho các kết nối
    sendfile on;
    keepalive_timeout 65;

    # ==========================================================
    # UPSTREAM: Định nghĩa các dịch vụ nội bộ (Docker Hostnames)
    # ==========================================================
    
    upstream api_gateway_http {
        server api-gateway:8081; 
    }

    upstream websocket_backend {
        server websocket-service:8082; 
    }

    # ==========================================================
    # SERVER: Lắng nghe và xử lý Requests
    # ==========================================================
    server {
        listen 8080;
        server_name localhost;

        # Tăng kích thước buffer cho header (quan trọng cho JWT dài)
        proxy_buffers 8 16k; 
        proxy_buffer_size 32k;
        
        # ------------------------------------------------------
        # 1. Định tuyến WebSocket Traffic (Real-time)
        # Endpoint: /ws/* (ví dụ: /ws/chat)
        # ------------------------------------------------------
        location ~ ^/ws/(.*) {
            # Tên của upstream (websocket_backend)
            proxy_pass http://websocket_backend;

            # Cấu hình BẮT BUỘC cho WebSocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade; # Yêu cầu nâng cấp lên WS
            proxy_set_header Connection "upgrade"; # Giữ kết nối mở

            # Cấu hình Header chuẩn
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_set_header Cookie $http_cookie;
            
            # Tắt caching cho WebSocket
            proxy_buffering off;
            
            # Tăng thời gian timeout cho kết nối WS dài
            proxy_read_timeout 86400s; # Ví dụ: 24 giờ
        }

        # ------------------------------------------------------
        # 2. Định tuyến HTTP/REST Traffic (API Gateway)
        # Tất cả các requests còn lại (/, /auth/*, /customer/*, etc.)
        # ------------------------------------------------------
        location / {
            # Tên của upstream (api_gateway_http)
            proxy_pass http://api_gateway_http;
            
            # BỔ SUNG: Đảm bảo sử dụng HTTP/1.1 cho upstream và xử lý header Connection
            # Điều này rất quan trọng để đảm bảo request body (dữ liệu login) được gửi đi đúng cách.
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Cấu hình Header chuẩn cho HTTP
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}