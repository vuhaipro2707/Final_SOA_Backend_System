services:
  nginx:
    image: nginx:stable-alpine
    container_name: chat_nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro 
    networks:
      - chat_network
    depends_on:
      - api-gateway
      - websocket-service

  api-gateway:
    build: 
      context: ./ApiGateway 
    container_name: api_gateway
    expose:
      - "8081"
    networks:
      - chat_network
    depends_on:
      - auth-service
      - customer-management-service
      - chat-command-service
      - chat-query-service
    volumes:
      - ./ApiGateway/app:/app
      # Tùy chọn: Volume cho các dependency (để tránh ghi đè các thư viện đã cài)
      - /app/venv

  websocket-service:
    build:
      context: ./websocket-service
    container_name: websocket-service
    expose:
      - "8082"
    networks:
      - chat_network
    depends_on:
      - redis
      - kafka
    environment:
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8082

  auth-service:
    build: 
      context: ./auth-service
    container_name: auth-service
    expose: 
      - "8083"
    networks:
      - chat_network
    depends_on:
      - postgres
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/chat_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
      SERVER_PORT: 8083

  customer-management-service:
    build: 
      context: ./customer-management-service
    container_name: customer_management_service
    expose: 
      - "8084"
    networks:
      - chat_network
    depends_on:
      - otp-service
      - mail-service
      - postgres
      - redis
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/chat_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
      SERVER_PORT: 8084

  chat-command-service:
    build:
      context: ./chat-command-service
    container_name: chat-command-service
    expose:
      - "8085"
    networks:
      - chat_network
    depends_on:
      - customer-management-service
      - postgres
      - kafka
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/chat_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8085

  chat-query-service:
    build:
      context: ./chat-query-service
    container_name: chat-query-service
    expose:
      - "8086"
    networks:
      - chat_network
    depends_on:
      - redis
      - mongodb
      - kafka
    environment:
      SPRING_DATA_MONGODB_HOST: mongodb
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_DATABASE: chat_read_db
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8086

  otp-service:
    build: 
      context: ./otp-service
    container_name: otp_service
    expose: 
      - "8087"
    networks:
      - chat_network
    depends_on:
      - redis
    environment:
      SPRING_DATA_REDIS_HOST: redis 
      SPRING_DATA_REDIS_PORT: 6379
      SERVER_PORT: 8087

  mail-service:
    build:
      context: ./mail-service 
    container_name: mail_service
    expose:
      - "8088"
    networks:
      - chat_network
    environment:
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}

  postgres:
    image: postgres:15-alpine
    container_name: student_db
    environment:
      POSTGRES_DB: chat_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    # volumes:
    #   - postgres_data:/var/lib/postgresql/data/ # Dùng Named Volume để lưu trữ dữ liệu
    networks:
      - chat_network

  mongodb:
    image: mongo:latest
    container_name: chat_mongodb
    # volumes:
    #   - mongodb_data:/data/db
    networks:
      - chat_network

  # === THAY THẾ pgadmin BẰNG Adminer (PostgreSQL/SQL UI đơn giản) ===
  adminer_postgres:
    image: adminer
    container_name: adminer_postgres_ui
    ports:
      - "8089:8080" # Truy cập: http://localhost:8089
    networks:
      - chat_network
    depends_on:
      - postgres
    # Giao diện đơn giản hơn, không cần đăng nhập UI, chỉ cần nhập thông tin kết nối DB.
    # Thông tin kết nối: System: PostgreSQL, Server: postgres, Username: user, Password: password, Database: chat_db

  # === THAY ĐỔI mongo-express ĐỂ BỎ QUA ĐĂNG NHẬP UI (MongoDB UI) ===
  mongo-express:
    image: mongo-express
    container_name: mongo_express_ui
    ports:
      - "8090:8081" # Truy cập: http://localhost:8090
    environment:
      ME_CONFIG_MONGODB_SERVER: mongodb 
      # Vô hiệu hóa Basic Authentication của giao diện Mongo Express (truy cập trực tiếp)
      ME_CONFIG_BASICAUTH_USERNAME: "1"
      ME_CONFIG_BASICAUTH_PASSWORD: "1"
    networks:
      - chat_network
    depends_on:
      - mongodb
  # =================================================================

  redis:
    image: redis:7-alpine
    container_name: redis_cache
    expose:
      - "6379"
    networks:
      - chat_network
    command: redis-server --notify-keyspace-events KEx

  kafka:
    image: apache/kafka:4.1.0
    container_name: chat_kafka
    expose:
      - "9092"
    networks:
      - chat_network
    volumes:
      - kafka_data:/var/lib/kafka/data 
    environment:
      KAFKA_PROCESS_ROLES: 'controller,broker' 
      KAFKA_NODE_ID: 1 
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093' 
      
      KAFKA_CLUSTER_ID: "AAAAAAAAAAAAAAAAAAAAAA" 
      
      KAFKA_LISTENERS: 'PLAINTEXT://:9092,CONTROLLER://:9093'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9092'
      
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

networks:
  chat_network:
    driver: bridge

volumes:
#   postgres_data:
#   mongodb_data:
  kafka_data: