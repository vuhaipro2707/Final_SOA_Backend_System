services:
  nginx:
    image: nginx:stable-alpine
    container_name: chat_nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro 
    networks:
      - chat_network
    depends_on:
      - api-gateway
      - websocket-service

  api-gateway:
    build: 
      context: ./ApiGateway 
    container_name: api_gateway
    expose:
      - "8081"
    networks:
      - chat_network
    volumes:
      - ./ApiGateway/app:/app
      # T√πy ch·ªçn: Volume cho c√°c dependency (ƒë·ªÉ tr√°nh ghi ƒë√® c√°c th∆∞ vi·ªán ƒë√£ c√†i)
      - /app/venv

  websocket-service:
    build:
      context: ./websocket-service
    container_name: websocket-service
    expose:
      - "8082"
    networks:
      - chat_network
    depends_on:
      - redis
      - kafka
    environment:
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVER_PORT: 8082

  auth-service:
    build: 
      context: ./auth-service
    container_name: auth-service
    expose: 
      - "8083"
    networks:
      - chat_network
    depends_on:
      - postgres
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/chat_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
      SERVER_PORT: 8083

  # user-management-service:
  #   build: 
  #     context: ./user-management-service
  #   container_name: user_management_service
  #   expose: 
  #     - "8084"
  #   networks:
  #     - chat_network
  #   depends_on:
  #     - postgres
  #   environment:
  #     SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/chat_db
  #     SPRING_DATASOURCE_USERNAME: user
  #     SPRING_DATASOURCE_PASSWORD: password
  #     SERVER_PORT: 8084

  # chat-command-service:
  #   build:
  #     context: ./chat-command-service
  #   container_name: chat-command-service
  #   expose:
  #     - "8085"
  #   networks:
  #     - chat_network
  #   depends_on:
  #     - postgres
  #     - kafka
  #   environment:
  #     SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/chat_db
  #     SPRING_DATASOURCE_USERNAME: user
  #     SPRING_DATASOURCE_PASSWORD: password
  #     SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #     SERVER_PORT: 8085

  # chat-query-service:
  #   build:
  #     context: ./chat-query-service
  #   container_name: chat-query-service
  #   expose:
  #     - "8086"
  #   networks:
  #     - chat_network
  #   depends_on:
  #     - mongodb
  #     - kafka
  #   environment:
  #     SPRING_DATA_MONGODB_HOST: mongodb
  #     SPRING_DATA_MONGODB_PORT: 27017
  #     SPRING_DATA_MONGODB_DATABASE: chat_read_db
  #     SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #     SERVER_PORT: 8086

  postgres:
    image: postgres:15-alpine
    container_name: student_db
    environment:
      POSTGRES_DB: chat_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    # volumes:
    #   - postgres_data:/var/lib/postgresql/data/ # D√πng Named Volume ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu
    networks:
      - chat_network

  mongodb:
    image: mongo:latest
    container_name: chat_mongodb
    # volumes:
    #   - mongodb_data:/data/db
    networks:
      - chat_network

  redis:
    image: redis:7-alpine
    container_name: redis_cache
    expose:
      - "6379"
    networks:
      - chat_network

  kafka:
    image: apache/kafka:4.1.0
    container_name: chat_kafka
    expose:
      - "9092"
    networks:
      - chat_network
    volumes:
      # Volume n√™n tr·ªè ƒë·∫øn th∆∞ m·ª•c data ti√™u chu·∫©n c·ªßa Kafka
      - kafka_data:/var/lib/kafka/data 
    environment:
      # üöÄ C·∫•u h√¨nh KRaft - S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng bi·∫øn m√¥i tr∆∞·ªùng Apache
      KAFKA_PROCESS_ROLES: 'controller,broker' 
      KAFKA_NODE_ID: 1 
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093' # ‚ö†Ô∏è QUAN TR·ªåNG: Controller c·∫ßn c·ªïng ri√™ng (9093)
      
      # ‚ö†Ô∏è T·∫†O CLUSTER ID - CH·ªà D√ôNG KHI KH·ªûI T·∫†O L·∫¶N ƒê·∫¶U
      # B·ªè ƒëi sau l·∫ßn kh·ªüi ƒë·ªông ƒë·∫ßu ti√™n n·∫øu b·∫°n mu·ªën n√≥ t·ª± ƒë·ªông t·∫°o
      KAFKA_CLUSTER_ID: "AAAAAAAAAAAAAAAAAAAAAA" 
      
      # üîë C·∫•u h√¨nh Listeners
      # Th√™m m·ªôt listener cho Controller (CONTROLLER_LISTENER)
      KAFKA_LISTENERS: 'PLAINTEXT://:9092,CONTROLLER://:9093'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9092'
      
      # ƒê·ªãa ch·ªâ cho giao ti·∫øp n·ªôi b·ªô c·ªßa Controller
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'

networks:
  chat_network:
    driver: bridge

volumes:
#   postgres_data:
#   mongodb_data:
  kafka_data: